!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Compressor=t()}(this,function(){"use strict";function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function t(){return(t=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r,a=arguments[t];for(r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}function r(e,t){var r,a=Object.keys(e);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(e),t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),a.push.apply(a,r)),a}function a(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach(function(t){var r,n;t=a[n=t],n in(r=e)?Object.defineProperty(r,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[n]=t}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))})}return e}var n,i=(function(e){var t,r,a,n,i,o,l;"undefined"!=typeof window&&(r=(t=window).HTMLCanvasElement&&t.HTMLCanvasElement.prototype,a=t.Blob&&function(){try{return Boolean(new Blob)}catch(e){return!1}}(),n=a&&t.Uint8Array&&function(){try{return 100===new Blob([new Uint8Array(100)]).size}catch(e){return!1}}(),i=t.BlobBuilder||t.WebKitBlobBuilder||t.MozBlobBuilder||t.MSBlobBuilder,o=/^data:((.*?)(;charset=.*?)?)(;base64)?,/,l=(a||i)&&t.atob&&t.ArrayBuffer&&t.Uint8Array&&function(e){var t,r,l,s,c,u=e.match(o);if(!u)throw new Error("invalid data URI");for(t=u[2]?u[1]:"text/plain"+(u[3]||";charset=US-ASCII"),l=!!u[4],u=e.slice(u[0].length),r=(l?atob:decodeURIComponent)(u),l=new ArrayBuffer(r.length),s=new Uint8Array(l),c=0;c<r.length;c+=1)s[c]=r.charCodeAt(c);return a?new Blob([n?s:l],{type:t}):((u=new i).append(l),u.getBlob(t))},t.HTMLCanvasElement&&!r.toBlob&&(r.mozGetAsFile?r.toBlob=function(e,t,a){var n=this;setTimeout(function(){e(a&&r.toDataURL&&l?l(n.toDataURL(t,a)):n.mozGetAsFile("blob",t))})}:r.toDataURL&&l&&(r.toBlob=r.msToBlob?function(e,t,a){var n=this;setTimeout(function(){e((t&&"image/png"!==t||a)&&r.toDataURL&&l?l(n.toDataURL(t,a)):n.msToBlob(t))})}:function(e,t,r){var a=this;setTimeout(function(){e(l(a.toDataURL(t,r)))})})),e.exports?e.exports=l:t.dataURLtoBlob=l)}(n={path:void 0,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}()}}),n.exports),o={strict:!0,checkOrientation:!0,maxWidth:1/0,maxHeight:1/0,minWidth:0,minHeight:0,width:void 0,height:void 0,quality:.8,mimeType:"auto",convertSize:5e6,beforeDraw:null,drew:null,success:null,error:null},l="undefined"!=typeof window&&void 0!==window.document?window:{},s=Array.prototype.slice,c=/^image\/.+$/;function u(e){return c.test(e)}var h=String.fromCharCode,f=l.btoa,d=/\.\d*(?:0|9){12}\d*$/;function m(e,t){return t=1<arguments.length&&void 0!==t?t:1e11,d.test(e)?Math.round(e*t)/t:e}var b=l.ArrayBuffer,p=l.FileReader,g=l.URL||l.webkitURL,y=/\.\w+$/,w=l.Compressor;return function(){function r(e,t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),this.file=e,this.image=new Image,this.options=a(a({},o),t),this.aborted=!1,this.result=null,this.init()}var n,c,d;return n=r,d=[{key:"noConflict",value:function(){return window.Compressor=w,r}},{key:"setDefaults",value:function(e){t(o,e)}}],(c=[{key:"init",value:function(){var e,r,a,n=this,i=this.file,o=this.options;r=i,"undefined"!=typeof Blob&&(r instanceof Blob||"[object Blob]"===Object.prototype.toString.call(r))?u(e=i.type)?g&&p?(b||(o.checkOrientation=!1),g&&!o.checkOrientation?this.load({url:g.createObjectURL(i)}):(r=new p,a=o.checkOrientation&&"image/jpeg"===e,(this.reader=r).onload=function(r){var o=r.target.result,l={};a?1<(r=function(e){var t,r,a,n,i,o,l=new DataView(e);try{if(255===l.getUint8(0)&&216===l.getUint8(1))for(var s=l.byteLength,c=2;c+1<s;){if(255===l.getUint8(c)&&225===l.getUint8(c+1)){r=c;break}c+=1}if(r&&(n=r+10,"Exif"===function(e,t,r){var a,n="";for(r+=t,a=t;a<r;a+=1)n+=h(e.getUint8(a));return n}(l,r+4,4)&&(!(o=18761===(i=l.getUint16(n)))&&19789!==i||42!==l.getUint16(n+2,o)||8<=(i=l.getUint32(n+4,o))&&(a=n+i))),a)for(var u,f=l.getUint16(a,o),d=0;d<f;d+=1)if(274===l.getUint16(u=a+12*d+2,o)){t=l.getUint16(u+=8,o),l.setUint16(u,1,o);break}}catch(e){t=1}return t}(o))||!g?(l.url=function(e,t){for(var r,a=[],n=new Uint8Array(e);0<n.length;)a.push(h.apply(null,(r=n.subarray(0,8192),Array.from?Array.from(r):s.call(r)))),n=n.subarray(8192);return"data:".concat(t,";base64,").concat(f(a.join("")))}(o,e),1<r&&t(l,function(e){var t=0,r=1,a=1;switch(e){case 2:r=-1;break;case 3:t=-180;break;case 4:a=-1;break;case 5:t=90,a=-1;break;case 6:t=90;break;case 7:t=90,r=-1;break;case 8:t=-90}return{rotate:t,scaleX:r,scaleY:a}}(r))):l.url=g.createObjectURL(i):l.url=o,n.load(l)},r.onabort=function(){n.fail(new Error("Aborted to read the image with FileReader."))},r.onerror=function(){n.fail(new Error("Failed to read the image with FileReader."))},r.onloadend=function(){n.reader=null},a?r.readAsArrayBuffer(i):r.readAsDataURL(i))):this.fail(new Error("The current browser does not support image compression.")):this.fail(new Error("The first argument must be an image File or Blob object.")):this.fail(new Error("The first argument must be a File or Blob object."))}},{key:"load",value:function(e){var t=this,r=this.file,n=this.image;n.onload=function(){t.draw(a(a({},e),{},{naturalWidth:n.naturalWidth,naturalHeight:n.naturalHeight}))},n.onabort=function(){t.fail(new Error("Aborted to load the image."))},n.onerror=function(){t.fail(new Error("Failed to load the image."))},l.navigator&&/(?:iPad|iPhone|iPod).*?AppleWebKit/i.test(l.navigator.userAgent)&&(n.crossOrigin="anonymous"),n.alt=r.name,n.src=e.url}},{key:"draw",value:function(e){var t=this,r=e.naturalWidth,a=e.naturalHeight,n=void 0===(U=e.rotate)?0:U,o=void 0===(O=e.scaleX)?1:O,l=e.scaleY,s=void 0===l?1:l,c=this.file,h=this.image,f=this.options,d=document.createElement("canvas"),b=d.getContext("2d"),p=r/a,g=Math.abs(n)%180==90,y=Math.max(f.maxWidth,0)||1/0,w=Math.max(f.maxHeight,0)||1/0,v=Math.max(f.minWidth,0)||0,U=Math.max(f.minHeight,0)||0,O=Math.max(f.width,0)||r;e=Math.max(f.height,0)||a,g&&(y=(l=[w,y])[0],w=l[1],v=(l=[U,v])[0],U=l[1],O=(l=[e,O])[0],e=l[1]),y<1/0&&w<1/0?y<w*p?w=y/p:y=w*p:y<1/0?w=y/p:w<1/0&&(y=w*p),0<v&&0<U?v<U*p?U=v/p:v=U*p:0<v?U=v/p:0<U&&(v=U*p),O<e*p?e=O/p:O=e*p,v=-(O=Math.floor(m(Math.min(Math.max(O,v),y))))/2,y=-(e=Math.floor(m(Math.min(Math.max(e,U),w))))/2,U=O,w=e,g&&(O=(B=[e,O])[0],e=B[1]),d.width=O,d.height=e,u(f.mimeType)||(f.mimeType=c.type);var B="transparent";c.size>f.convertSize&&"image/png"===f.mimeType&&(B="#fff",f.mimeType="image/jpeg"),b.fillStyle=B,b.fillRect(0,0,O,e),f.beforeDraw&&f.beforeDraw.call(this,b,d),this.aborted||(b.save(),b.translate(O/2,e/2),b.rotate(n*Math.PI/180),b.scale(o,s),b.drawImage(h,v,y,U,w),b.restore(),f.drew&&f.drew.call(this,b,d),this.aborted||(b=function(e){t.aborted||t.done({naturalWidth:r,naturalHeight:a,result:e})},d.toBlob?d.toBlob(b,f.mimeType,f.quality):b(i(d.toDataURL(f.mimeType,f.quality)))))}},{key:"done",value:function(e){var t=e.naturalWidth,r=e.naturalHeight,a=e.result,n=this.file;e=this.options,g&&!e.checkOrientation&&g.revokeObjectURL(this.image.src),!a||e.strict&&a.size>n.size&&e.mimeType===n.type&&!(e.width>t||e.height>r||e.minWidth>t||e.minHeight>r)?a=n:(r=new Date,a.lastModified=r.getTime(),a.lastModifiedDate=r,a.name=n.name,a.name&&a.type!==n.type&&(a.name=a.name.replace(y,("jpeg"===(n=u(n=a.type)?n.substr(6):"")&&(n="jpg"),".".concat(n))))),this.result=a,e.success&&e.success.call(this,a)}},{key:"fail",value:function(e){var t=this.options;if(!t.error)throw e;t.error.call(this,e)}},{key:"abort",value:function(){this.aborted||(this.aborted=!0,this.reader?this.reader.abort():this.image.complete?this.fail(new Error("The compression process has been aborted.")):(this.image.onload=null,this.image.onabort()))}}])&&e(n.prototype,c),d&&e(n,d),r}()});